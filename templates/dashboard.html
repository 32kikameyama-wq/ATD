<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
        <div class="main-layout">
            <!-- ‰∏äÈÉ®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
            <nav class="navbar">
                <div class="navbar-content">
                    <div class="navbar-brand">ATD</div>
                    <div class="navbar-menu">
                        <a href="{{ url_for('main.dashboard') }}" class="navbar-item active">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>
                        <a href="{{ url_for('tasks.list_tasks') }}" class="navbar-item">„Çø„Çπ„ÇØÁÆ°ÁêÜ</a>
                        <a href="{{ url_for('main.mindmap') }}" class="navbar-item">„Éû„Ç§„É≥„Éâ„Éû„ÉÉ„Éó</a>
                        {% if current_user.is_admin %}
                            <a href="{{ url_for('main.admin') }}" class="navbar-item">ÁÆ°ÁêÜËÄÖ</a>
                        {% endif %}
                        <a href="{{ url_for('main.profile') }}" class="navbar-item">„Éó„É≠„Éï„Ç£„Éº„É´</a>
                    </div>
                    <div class="user-controls">
                        <a href="{{ url_for('main.notifications') }}" class="btn btn-sm" style="position: relative; margin-right: 5px;">
                            üîî
                            {% if unread_notifications > 0 %}
                                <span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">{{ unread_notifications }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
                        <a href="#" class="user-control active personal-mode">
                            ÂÄã‰∫∫
                        </a>
                        <a href="#" class="user-control">
                            „ÉÅ„Éº„É†
                        </a>
                        <a href="{{ url_for('main.profile') }}" class="user-control">
                            {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                        </a>
                    </div>
                </div>
            </nav>

            <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="container">
                <div class="page-header">
                    <h1>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{{ url_for('main.calendar') }}" class="btn btn-secondary">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº</a>
                        <a href="{{ url_for('main.task_templates') }}" class="btn btn-secondary">üìù „ÉÜ„É≥„Éó„É¨„Éº„Éà</a>
                        <a href="{{ url_for('main.daily_report') }}" class="btn btn-primary">üìä Êó•Â†±„É¨„Éù„Éº„Éà</a>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- ‰∏äÊÆµÂ∑¶ÔºöÂÄã‰∫∫„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                    <div class="card performance-card">
                        <div class="card-header">
                            <h3>„ÉªÂÄã‰∫∫„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h3>
                        </div>
                        <div class="performance-stats">
                            <div class="stat-item">
                                <div class="stat-value">{{ total_tasks }}</div>
                                <div class="stat-label">‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ completed_tasks }}</div>
                                <div class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ "%.1f"|format(progress_percentage) }}%</div>
                                <div class="stat-label">ÂÆå‰∫ÜÁéá</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ streak_days }}Êó•</div>
                                <div class="stat-label">ÈÄ£Á∂öÈÅîÊàê</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏äÊÆµÂè≥Ôºö‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„Å®ÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØ„ÇíÊ®™‰∏¶„Å≥ -->
                    <div style="display: flex; gap: var(--spacing-md); height: 100%;">
                        <!-- Êú¨Êó•„ÅÆ„Çø„Çπ„ÇØ -->
                        <div class="card today-tasks-card" style="flex: 1;">
                            <div class="card-header">
                                <h3>„Éª‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ ({{ total_tasks }}‰ª∂)</h3>
                                <a href="{{ url_for('tasks.list_tasks') }}" class="btn btn-sm btn-outline">„Åô„Åπ„Å¶Ë°®Á§∫</a>
                            </div>
                            <div class="today-tasks-content">
                                {% if today_tasks %}
                                    {% for task in today_tasks[:5] %}
                                        <div class="dashboard-task-item {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
                                            <div class="task-checkbox">
                                                <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="POST" style="display:inline;">
                                                    <button type="submit" class="task-toggle-btn {% if task.completed %}completed{% endif %}">
                                                        {% if task.completed %}‚úì{% else %}‚óã{% endif %}
                                                    </button>
                                                </form>
                                            </div>
                                            <div class="task-info">
                                                <div class="task-title">{{ task.title }}</div>
                                                <div class="task-meta">
                                                    <span class="priority-badge priority-{{ task.priority }}">
                                                        {% if task.priority == 'high' %}È´ò
                                                        {% elif task.priority == 'medium' %}‰∏≠
                                                        {% elif task.priority == 'low' %}‰Ωé
                                                        {% else %}{{ task.priority }}{% endif %}
                                                    </span>
                                                    {% if task.due_date %}
                                                        <span class="due-date">{{ task.due_date }}</span>
                                                    {% endif %}
                                                    <span style="color: #666; font-size: 0.85rem;">‚è±Ô∏è {{ task.format_time() if task.format_time else '00:00:00' }}</span>
                                                    {% if task.is_tracking %}
                                                        <span style="color: #f44336; font-size: 0.85rem; animation: blink 1s infinite;">‚óè Ë®àÊ∏¨‰∏≠</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="task-controls">
                                                <button class="btn btn-sm btn-outline" onclick="moveTaskUp({{ task.id }})">‚Üë</button>
                                                <button class="btn btn-sm btn-outline" onclick="moveTaskDown({{ task.id }})">‚Üì</button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% if today_tasks|length > 5 %}
                                        <div class="more-tasks">
                                            <a href="{{ url_for('tasks.list_tasks') }}">‰ªñ{{ today_tasks|length - 5 }}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫</a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="no-tasks">
                                        <p>Êú¨Êó•„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                        <a href="{{ url_for('tasks.create_task') }}" class="btn btn-primary">„Çø„Çπ„ÇØ„Çí‰ΩúÊàê</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØ -->
                        <div class="card today-tasks-card" style="flex: 1;">
                            <div class="card-header">
                                <h3>„ÉªÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØ</h3>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="date" id="past-date-selector" onchange="loadPastTasks()" style="padding: 3px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.75rem;">
                                    {% if selected_date %}
                                        <button onclick="clearPastTasks()" class="btn btn-sm btn-outline" style="padding: 3px 8px; font-size: 0.75rem;">„ÇØ„É™„Ç¢</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="today-tasks-content" style="max-height: 400px; overflow-y: auto;">
                                {% if selected_date %}
                                    <div style="margin-bottom: 10px; padding: 10px; background: #f0f9ff; border-radius: 4px;">
                                        <strong>{{ selected_date.strftime('%YÂπ¥%mÊúà%dÊó•') }}„ÅÆ„Çø„Çπ„ÇØ</strong>
                                    </div>
                                    {% if past_tasks %}
                                        {% for task in past_tasks %}
                                            <div class="dashboard-task-item {% if task.completed %}completed{% endif %}" style="margin-bottom: 10px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="font-size: 1.2rem;">
                                                        {% if task.completed %}‚úì{% else %}‚óã{% endif %}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: bold; {% if task.completed %}text-decoration: line-through; opacity: 0.6;{% endif %}">{{ task.title }}</div>
                                                        <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                                            <span class="priority-badge priority-{{ task.priority }}">
                                                                {% if task.priority == 'high' %}È´ò
                                                                {% elif task.priority == 'medium' %}‰∏≠
                                                                {% elif task.priority == 'low' %}‰Ωé
                                                                {% else %}{{ task.priority }}{% endif %}
                                                            </span>
                                                            {% if task.due_date %}
                                                                <span style="margin-left: 5px;">ÊúüÈôê: {{ task.due_date }}</span>
                                                            {% endif %}
                                                            {% if task.completed %}
                                                                <span style="margin-left: 5px; color: #059669;">ÂÆå‰∫Ü</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-tasks">
                                            <p>„Åì„ÅÆÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="no-tasks">
                                        <p>Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶ÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØ„ÇíË°®Á§∫</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ãÊÆµÔºöÈÄ≤ÊçóÂàÜÊûê„Å®ÊôÇÈñìÂàÜÊûê„ÇíÊ®™‰∏¶„Å≥ -->
                    <div class="card analysis-card" style="grid-column: 1;">
                        <div class="card-header">
                            <h3>„ÉªÈÄ≤ÊçóÂàÜÊûê</h3>
                        </div>
                        <div class="analysis-content">
                            <div class="progress-stats">
                                <div class="progress-item">
                                    <div class="progress-label">Êú¨Êó•„ÅÆÈÄ≤Êçó</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                                    </div>
                                    <div class="progress-text">{{ "%.1f"|format(progress_percentage) }}% ({{ completed_tasks }}/{{ total_tasks }})</div>
                                </div>
                                <div class="progress-summary">
                                    <div class="summary-item">
                                        <span class="summary-label">ÂÆå‰∫ÜÊ∏à„Åø</span>
                                        <span class="summary-value completed">{{ completed_tasks }}‰ª∂</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">ÊÆã„Çä</span>
                                        <span class="summary-value remaining">{{ total_tasks - completed_tasks }}‰ª∂</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="progressChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ãÊÆµÂè≥ÔºöÊôÇÈñìÂàÜÊûê -->
                    <div class="card analysis-card" style="grid-column: 2;">
                        <div class="card-header">
                            <h3>„ÉªÊôÇÈñìÂàÜÊûê</h3>
                        </div>
                        <div class="analysis-content">
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af;">
                                    ‚è±Ô∏è {% set hours = today_total_seconds // 3600 %}{% set minutes = (today_total_seconds % 3600) // 60 %}{{ "{:02d}:{:02d}".format(hours, minutes) }}
                                </div>
                                <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">
                                    Êú¨Êó•„ÅÆÁ∑è‰ΩúÊ•≠ÊôÇÈñì
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="timeChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="priorityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÄã‰∫∫/„ÉÅ„Éº„É†Âàá„ÇäÊõø„Åà
        document.querySelectorAll('.user-control').forEach(control => {
            control.addEventListener('click', function(e) {
                e.preventDefault();
                
                // ÂÖ®„Å¶„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
                document.querySelectorAll('.user-control').forEach(c => c.classList.remove('active'));
                
                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç≥„É≥„Éà„É≠„Éº„É´„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
                this.classList.add('active');
                
                const mode = this.textContent.trim();
                console.log('Âàá„ÇäÊõø„Åà:', mode);
                
                // „Ç´„É©„Éº„É¢„Éº„Éâ„ÇíÈÅ©Áî®
                if (mode === '„ÉÅ„Éº„É†') {
                    // „ÉÅ„Éº„É†„É¢„Éº„Éâ„Å´ÈÅ∑Áßª
                    window.location.href = '/team-management';
                }
            });
        });

        // ÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØ„ÇíË™≠„ÅøËæº„ÇÄ
        function loadPastTasks() {
            const dateInput = document.getElementById('past-date-selector');
            const selectedDate = dateInput.value;
            
            if (selectedDate) {
                const url = new URL(window.location.href);
                url.searchParams.set('past_date', selectedDate);
                window.location.href = url.toString();
            }
        }

        // ÈÅéÂéª„ÅÆ„Çø„Çπ„ÇØË°®Á§∫„Çí„ÇØ„É™„Ç¢
        function clearPastTasks() {
            const url = new URL(window.location.href);
            url.searchParams.delete('past_date');
            window.location.href = url.toString();
        }

        // ÈÅ∏Êäû„Åï„Çå„ÅüÊó•‰ªò„Çí„Çª„ÉÉ„Éà
        {% if selected_date %}
            document.getElementById('past-date-selector').value = '{{ selected_date.strftime('%Y-%m-%d') }}';
        {% endif %}

        // „Çø„Çπ„ÇØ„ÅÆÂÑ™ÂÖàÈ†Ü‰ΩçÂ§âÊõ¥
        function moveTaskUp(taskId) {
            fetch(`/tasks/${taskId}/reorder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ direction: 'up' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }
        
        function moveTaskDown(taskId) {
            fetch(`/tasks/${taskId}/reorder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ direction: 'down' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }

        // Chart.js „Åß„Ç∞„É©„Éï„ÇíÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÈÄ≤ÊçóÂàÜÊûê„Ç∞„É©„ÉïÔºàÈÅéÂéª7Êó•Èñì„ÅÆÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞Ôºâ
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: {{ labels | tojson }},
                    datasets: [{
                        label: 'ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞',
                        data: {{ daily_completion_data | tojson }},
                        borderColor: '#008b8b',
                        backgroundColor: 'rgba(0, 139, 139, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÈÅéÂéª7Êó•Èñì„ÅÆÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞',
                            font: {
                                size: 12
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ÊôÇÈñìÂàÜÊûê„Ç∞„É©„ÉïÔºà„Çø„Çπ„ÇØÂà•‰ΩúÊ•≠ÊôÇÈñìÔºâ
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            {% if task_time_data %}
            const taskTimeLabels = {{ task_time_data | map(attribute='title') | list | tojson }};
            const taskTimeData = {{ task_time_data | map(attribute='total_seconds') | list | tojson }};
            
            new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: taskTimeLabels,
                    datasets: [{
                        label: '‰ΩúÊ•≠ÊôÇÈñìÔºàÁßíÔºâ',
                        data: taskTimeData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '„Çø„Çπ„ÇØÂà•‰ΩúÊ•≠ÊôÇÈñì',
                            font: {
                                size: 12
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    const hours = Math.floor(value / 3600);
                                    const minutes = Math.floor((value % 3600) / 60);
                                    return `${hours}:${String(minutes).padStart(2, '0')}`;
                                }
                            }
                        }
                    }
                }
            });
            {% endif %}

            // ÂÑ™ÂÖàÂ∫¶ÂàÜÊûê„Ç∞„É©„Éï
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: ['È´ò', '‰∏≠', '‰Ωé'],
                    datasets: [{
                        label: '„Çø„Çπ„ÇØÊï∞',
                        data: [
                            {{ priority_data.high }},
                            {{ priority_data.medium }},
                            {{ priority_data.low }}
                        ],
                        backgroundColor: [
                            '#dc2626',
                            '#d97706',
                            '#059669'
                        ],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÂÑ™ÂÖàÂ∫¶Âà•„Çø„Çπ„ÇØÊï∞',
                            font: {
                                size: 12
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
