<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÅ„Éº„É†„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - {{ team.name }} - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="team-mode">
    <div class="app-layout">
        <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
        <div class="main-layout">
            <!-- ‰∏äÈÉ®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
            <nav class="navbar">
                <div class="navbar-content">
                    <div class="navbar-brand">
    <span class="brand-title">ATD</span>
    <span class="brand-date">{{ current_date_display }}</span>
</div>
                    <div class="navbar-menu">
                        <a href="{{ url_for('main.team_management') }}" class="navbar-item">„ÉÅ„Éº„É†</a>
                        <a href="{{ url_for('main.team_mindmap') }}" class="navbar-item">„ÉÅ„Éº„É†ÁõÆÊ®ô</a>
                        <a href="{{ url_for('main.team_tasks') }}" class="navbar-item">„ÉÅ„Éº„É†„Çø„Çπ„ÇØ</a>
                    </div>
                    <div class="user-controls">
                        <a href="{{ url_for('main.notifications') }}" class="btn btn-sm" style="position: relative; margin-right: 5px;">
                            üîî
                            {% if unread_notifications > 0 %}
                                <span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">{{ unread_notifications }}</span>
                            {% endif %}
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
                        <a href="{{ url_for('main.dashboard') }}" class="user-control">
                            ÂÄã‰∫∫
                        </a>
                        <a href="#" class="user-control active team-mode">
                            „ÉÅ„Éº„É†
                        </a>
                        <a href="{{ url_for('main.profile') }}" class="user-control">
                            {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                        </a>
                    </div>
                </div>
            </nav>

            <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="container">
                <div class="page-header">
                    <div>
                        <h1>{{ team.name }}</h1>
                        {% if team.description %}
                            <p class="team-description">{{ team.description }}</p>
                        {% endif %}
                    </div>
                    <div class="header-actions">
                        <div class="date-range-selector">
                            <label for="start-date">ÈñãÂßãÊó•:</label>
                            <input type="date" id="start-date" value="{{ start_date.strftime('%Y-%m-%d') }}" onchange="updateDateRange()">
                            <label for="end-date" style="margin-left: 10px;">ÁµÇ‰∫ÜÊó•:</label>
                            <input type="date" id="end-date" value="{{ end_date.strftime('%Y-%m-%d') }}" onchange="updateDateRange()">
                            <button onclick="resetToToday()" class="btn btn-sm btn-secondary" style="margin-left: 10px;">Êú¨Êó•</button>
                        </div>
                        <a href="{{ url_for('main.team_management') }}" class="btn btn-secondary btn-sm">„ÉÅ„Éº„É†ÁÆ°ÁêÜ„Å´Êàª„Çã</a>
                    </div>
                </div>

                <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ -->
                <div class="dashboard-grid">
                    <!-- ‰∏äÊÆµÂ∑¶Ôºö„ÉÅ„Éº„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                    <div class="card performance-card">
                        <div class="card-header">
                            <h3>„Éª„ÉÅ„Éº„É†„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h3>
                            <div class="period-info">
                                {% if start_date == end_date %}
                                    {{ start_date.strftime('%YÂπ¥%mÊúà%dÊó•') }}
                                {% else %}
                                    {{ start_date.strftime('%YÂπ¥%mÊúà%dÊó•') }} ÔΩû {{ end_date.strftime('%YÂπ¥%mÊúà%dÊó•') }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="performance-stats">
                            <div class="stat-item">
                                <div class="stat-value">{{ total_tasks }}</div>
                                <div class="stat-label">„ÉÅ„Éº„É†„Çø„Çπ„ÇØ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ completed_tasks }}</div>
                                <div class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ "%.1f"|format(progress_percentage) }}%</div>
                                <div class="stat-label">ÂÆå‰∫ÜÁéá</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏äÊÆµÂè≥Ôºö‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ -->
                    <div class="card today-tasks-card">
                        <div class="card-header">
                            <h3>„Éª{% if start_date == end_date %}‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ{% else %}ÊúüÈñìÂÜÖ„ÅÆ„Çø„Çπ„ÇØ{% endif %} ({{ total_tasks }}‰ª∂)</h3>
                        </div>
                        <div class="today-tasks-content">
                            {% if today_tasks %}
                                {% for task in today_tasks[:5] %}
                                    <div class="dashboard-task-item {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
                                        <div class="task-checkbox">
                                            <button class="task-toggle-btn {% if task.completed %}completed{% endif %}" disabled>
                                                {% if task.completed %}‚úì{% else %}‚óã{% endif %}
                                            </button>
                                        </div>
                                        <div class="task-info">
                                            <div class="task-title">{{ task.title }}</div>
                                            <div class="task-meta">
                                                <span class="priority-badge priority-{{ task.priority }}">{{ task.priority }}</span>
                                                {% if task.assigned_to %}
                                                    <span class="assigned-to">ÊãÖÂΩì: {{ task.assigned_to }}</span>
                                                {% endif %}
                                                {% if task.due_date %}
                                                    <span class="due-date">{{ task.due_date }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% if today_tasks|length > 5 %}
                                    <div class="more-tasks">
                                        <span>‰ªñ{{ today_tasks|length - 5 }}‰ª∂„ÅÆ„Çø„Çπ„ÇØ</span>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="no-tasks">
                                    <p>Êú¨Êó•„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ‰∏ãÊÆµÂ∑¶Ôºö„ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂÖ®‰Ωì -->
                    <div class="card performance-card">
                        <div class="card-header">
                            <h3>„Éª„ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂÖ®‰Ωì</h3>
                            <div class="period-info">
                                {% if start_date == end_date %}
                                    {{ start_date.strftime('%YÂπ¥%mÊúà%dÊó•') }}
                                {% else %}
                                    {{ start_date.strftime('%YÂπ¥%mÊúà%dÊó•') }} ÔΩû {{ end_date.strftime('%YÂπ¥%mÊúà%dÊó•') }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="performance-stats">
                            <div class="stat-item">
                                <div class="stat-value">{{ "%.1f"|format(personal_progress_percentage) }}%</div>
                                <div class="stat-label">ÂÆå‰∫ÜÁéá</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ personal_total_tasks }}</div>
                                <div class="stat-label">„Çø„Çπ„ÇØÊï∞</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ personal_completed_tasks }}</div>
                                <div class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ãÊÆµÂè≥Ôºö„ÉÅ„Éº„É†Áµ±Ë®à -->
                    <div class="card analysis-card">
                        <div class="card-header">
                            <h3>„Éª„ÉÅ„Éº„É†Áµ±Ë®à</h3>
                        </div>
                        <div class="analysis-content">
                            <div class="team-stats">
                                <div class="stat-item">
                                    <div class="stat-label">„ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÊï∞</div>
                                    <div class="stat-value">{{ team_members|length }}‰∫∫</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">„ÉÅ„Éº„É†„Çø„Çπ„ÇØÊï∞</div>
                                    <div class="stat-value">{{ total_tasks }}‰ª∂</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ÂÆå‰∫ÜÁéá</div>
                                    <div class="stat-value">{{ "%.1f"|format(progress_percentage) }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „É°„É≥„Éê„ÉºÂà•ÈÄ≤ÊçóÔºà‰∏ã„Å´ÁßªÂãïÔºâ -->
                    <div class="card analysis-card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <h3>„Éª„É°„É≥„Éê„ÉºÂà•ÈÄ≤Êçó</h3>
                        </div>
                        <div class="analysis-content">
                            {% for member in team_members %}
                                <div class="member-progress">
                                    <div class="member-info">
                                        <span class="member-name">{{ member.username }}</span>
                                        <span class="member-stats">
                                            {{ member_stats[member.id].completed }}/{{ member_stats[member.id].assigned }}
                                        </span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ member_stats[member.id].completion_rate }}%"></div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .page-header h1 {
            margin: 0;
        }

        .team-description {
            margin: var(--spacing-xs) 0 0 0;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .member-progress {
            margin-bottom: var(--spacing-md);
        }

        .member-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }

        .member-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .member-stats {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .team-stats .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid #e0e0e0;
        }

        .team-stats .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .assigned-to {
            font-size: 10px;
            color: var(--text-secondary);
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .date-range-selector label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .date-range-selector input[type="date"] {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: var(--font-size-sm);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .period-info {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: normal;
        }
    </style>

    <script>
        function updateDateRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                const url = new URL(window.location.href);
                url.searchParams.set('start_date', startDate);
                url.searchParams.set('end_date', endDate);
                window.location.href = url.toString();
            }
        }

        function resetToToday() {
            const today = new Date().toISOString().split('T')[0];
            const url = new URL(window.location.href);
            url.searchParams.set('start_date', today);
            url.searchParams.set('end_date', today);
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
