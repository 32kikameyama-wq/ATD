<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£æ‰“ã¡ - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .brainstorm-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .goal-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .goal-section h2 {
            margin-top: 0;
        }
        
        .conversation-area {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: 20%;
        }
        
        .message.assistant {
            background: #f5f5f5;
            margin-right: 20%;
        }
        
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .message-content {
            line-height: 1.6;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .input-area button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .input-area button:hover {
            background: #1976D2;
        }
        
        .suggested-tasks {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .suggested-tasks h3 {
            margin-top: 0;
        }
        
        .suggested-task-item {
            background: #fff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .suggested-task-item .task-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .suggested-task-item .task-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .suggested-task-item .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #999;
        }
        
        .task-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .task-actions input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 150px;
        }
        
        .task-actions button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .task-actions button:hover {
            background: #45a049;
        }
        
        .task-actions button.secondary {
            background: #ff9800;
        }
        
        .task-actions button.secondary:hover {
            background: #f57c00;
        }
        
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .no-session {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="main-layout">
            <!-- ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
            <nav class="navbar">
                <div class="navbar-content">
                    <div class="navbar-brand">ATD</div>
                    <div class="navbar-menu">
                        <a href="{{ url_for('main.dashboard') }}" class="navbar-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                        <a href="{{ url_for('tasks.list_tasks') }}" class="navbar-item">ã‚¿ã‚¹ã‚¯ç®¡ç†</a>
                        <a href="{{ url_for('main.mindmap') }}" class="navbar-item">ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</a>
                        <a href="{{ url_for('main.brainstorm') }}" class="navbar-item active">å£æ‰“ã¡</a>
                        {% if current_user.is_admin %}
                            <a href="{{ url_for('main.admin') }}" class="navbar-item">ç®¡ç†è€…</a>
                        {% endif %}
                        <a href="{{ url_for('main.profile') }}" class="navbar-item">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
                    </div>
                    <div class="user-controls">
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                        <a href="{{ url_for('main.profile') }}" class="user-control">
                            {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                        </a>
                    </div>
                </div>
            </nav>

            <div class="brainstorm-container">
                <h1>ğŸ¤– AIã‚¿ã‚¹ã‚¯ä¸€æ‹¬ä½œæˆ</h1>
                
                <div class="goal-section" style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h2 style="margin-top: 0; color: #1976D2;">ğŸ“‹ ä½¿ã„æ–¹</h2>
                    <p style="font-size: 1.1rem; color: #333; margin: 10px 0;">
                        <strong>å®Ÿè¡Œæ—¥ã¨ã‚¿ã‚¹ã‚¯ã‚’é€ã£ã¦ãã ã•ã„</strong><br>
                        ä¾‹: ã€Œ11/4ã‹ã‚‰10æ—¥é–“åˆ†ã€å–¶æ¥­æ´»å‹•ã®ã‚¿ã‚¹ã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€<br>
                        ä¾‹: ã€Œã“ã®ã‚¿ã‚¹ã‚¯ã‚’30æ—¥é–“åˆ†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¥ã‚Œã¦ã€<br>
                        ä¾‹: ã€Œ1ãƒ¶æœˆåˆ†æ—¥å‰²ã‚Šã§ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ã€
                    </p>
                </div>
                
                {% if session %}
                    <div class="goal-section">
                        <h2>ç›®æ¨™ãƒ»ç›®çš„</h2>
                        <p id="goal-text">{{ session.goal or 'ç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„' }}</p>
                    </div>
                    
                    <div class="conversation-area" id="conversation-area">
                        {% for message in session.messages %}
                            <div class="message {{ message.role }}">
                                <div class="message-header">{{ 'ã‚ãªãŸ' if message.role == 'user' else 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ' }}</div>
                                <div class="message-content">{{ message.content }}</div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="message-input" placeholder="å®Ÿè¡Œæ—¥ã¨ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: 11/4ã‹ã‚‰10æ—¥é–“åˆ†ã€å–¶æ¥­æ´»å‹•ã‚’å…¥ã‚Œã¦ãã ã•ã„)" />
                        <button onclick="sendMessage()">é€ä¿¡</button>
                    </div>
                    
                    <input type="hidden" id="session-id" value="{{ session.id }}" />
                {% else %}
                    <div class="no-session">
                        <div class="goal-section">
                            <h2>ç›®æ¨™ãƒ»ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
                            <p style="color: #666; margin-bottom: 15px;">
                                ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šé©åˆ‡ãªã‚¿ã‚¹ã‚¯ã‚’ææ¡ˆã§ãã¾ã™ã€‚<br>
                                ç›®æ¨™ãŒãªãã¦ã‚‚ã€ç›´æ¥ã€Œå®Ÿè¡Œæ—¥ã¨ã‚¿ã‚¹ã‚¯ã€ã‚’é€ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                            </p>
                            <div class="input-area">
                                <input type="text" id="goal-input" placeholder="ä¾‹: ãƒ­ã‚±ãƒƒãƒˆãƒŠã‚¦ã®å–¶æ¥­ã§50ä»¶åˆ¶ç´„ï¼ˆä»»æ„ï¼‰" />
                                <button onclick="createSession()">é–‹å§‹</button>
                            </div>
                            <p style="color: #999; font-size: 0.9rem; margin-top: 10px;">
                                â€» ç›®æ¨™ãªã—ã§ã‚‚é–‹å§‹ã§ãã¾ã™ã€‚ãã®å ´åˆã¯ã€Œé–‹å§‹ã€ã‚’æŠ¼ã•ãšã«ã€ä¸‹è¨˜ã‹ã‚‰ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                        <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                            <h3 style="margin-top: 0;">ã¾ãŸã¯ã€ç›®æ¨™ãªã—ã§ç›´æ¥ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</h3>
                            <div class="input-area">
                                <input type="text" id="direct-message-input" placeholder="ä¾‹: 11/4ã‹ã‚‰10æ—¥é–“åˆ†ã€å–¶æ¥­æ´»å‹•ã®ã‚¿ã‚¹ã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„" />
                                <button onclick="sendDirectMessage()">é€ä¿¡</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="session-id" value="" />
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        const sessionId = document.getElementById('session-id')?.value;
        const messageInput = document.getElementById('message-input');
        const directMessageInput = document.getElementById('direct-message-input');
        
        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        if (directMessageInput) {
            directMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendDirectMessage();
                }
            });
        }
        
        async function createSession() {
            const goalInput = document.getElementById('goal-input');
            const goal = goalInput.value.trim();
            
            if (!goal) {
                alert('ç›®æ¨™ãƒ»ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch('/brainstorm/session/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ goal: goal })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    location.reload();
                } else {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            const sessionId = document.getElementById('session-id')?.value;
            
            if (!message) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage('user', message);
            input.value = '';
            
            await sendMessageWithSession(sessionId, message);
        }
        
        function addMessage(role, content) {
            const conversationArea = document.getElementById('conversation-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-header">${role === 'user' ? 'ã‚ãªãŸ' : 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ'}</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            conversationArea.appendChild(messageDiv);
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }
        
        function displaySuggestedTasks(tasks) {
            const suggestedTasksDiv = document.getElementById('suggested-tasks');
            const tasksListDiv = document.getElementById('suggested-tasks-list');
            
            tasksListDiv.innerHTML = '';
            
            tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'suggested-task-item';
                taskDiv.innerHTML = `
                    <div class="checkbox-item">
                        <input type="checkbox" class="task-checkbox" value="${task.id}" checked />
                        <div>
                            <div class="task-title">${escapeHtml(task.title)}</div>
                            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                            <div class="task-meta">
                                <span>å„ªå…ˆåº¦: ${task.priority}</span>
                                ${task.suggested_date ? `<span>æ—¥ä»˜: ${task.suggested_date}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                tasksListDiv.appendChild(taskDiv);
            });
            
            suggestedTasksDiv.style.display = 'block';
        }
        
        async function createAllTasks() {
            if (!sessionId) return;
            
            const dateInput = document.getElementById('task-date-input').value.trim();
            const durationInput = document.getElementById('task-duration-input').value.trim();
            
            try {
                const response = await fetch(`/brainstorm/session/${sessionId}/tasks/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_ids: [],
                        date: dateInput,
                        duration: durationInput
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦é–‰ã˜ã‚‹
                    if (window.opener) {
                        window.opener.location.reload();
                        window.close();
                    } else {
                        location.href = '/tasks';
                    }
                } else {
                    alert('ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        async function createSelectedTasks() {
            const sessionId = document.getElementById('session-id')?.value;
            if (!sessionId) return;
            
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                alert('ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const dateInput = document.getElementById('task-date-input')?.value.trim() || '';
            const durationInput = document.getElementById('task-duration-input')?.value.trim() || '';
            
            try {
                const response = await fetch(`/brainstorm/session/${sessionId}/tasks/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_ids: selectedIds,
                        date: dateInput,
                        duration: durationInput
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦é–‰ã˜ã‚‹
                    if (window.opener) {
                        window.opener.location.reload();
                        window.close();
                    } else {
                        location.href = '/tasks';
                    }
                } else {
                    alert('ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function sendDirectMessage() {
            const input = document.getElementById('direct-message-input');
            const message = input.value.trim();
            
            if (!message) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆç›®æ¨™ãªã—ã§ã‚‚OKï¼‰
            try {
                const response = await fetch('/brainstorm/session/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ goal: '' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¨­å®š
                    document.getElementById('session-id').value = data.session_id;
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                    const input = document.getElementById('direct-message-input');
                    const message = input.value.trim();
                    input.value = '';
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const conversationArea = document.getElementById('conversation-area');
                    if (!conversationArea) {
                        // conversation-areaãŒãªã„å ´åˆã¯ä½œæˆ
                        const container = document.querySelector('.brainstorm-container');
                        const newArea = document.createElement('div');
                        newArea.className = 'conversation-area';
                        newArea.id = 'conversation-area';
                        container.insertBefore(newArea, document.querySelector('.input-area') || container.lastChild);
                    }
                    addMessage('user', message);
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                    await sendMessageWithSession(data.session_id, message);
                } else {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        async function sendMessageWithSession(sessionId, message) {
            try {
                const response = await fetch(`/brainstorm/session/${sessionId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ã‚¿ã‚¹ã‚¯ãŒä½œæˆã•ã‚ŒãŸå ´åˆã¯è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦é–‰ã˜ã‚‹
                    if (data.redirect) {
                        alert(data.assistant_message);
                        if (window.opener) {
                            window.opener.location.reload();
                            window.close();
                        } else {
                            location.href = data.redirect;
                        }
                        return;
                    }
                    
                    // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®è¿”ç­”ã‚’è¡¨ç¤º
                    addMessage('assistant', data.assistant_message);
                    
                    // ææ¡ˆã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                    if (data.suggested_tasks && data.suggested_tasks.length > 0) {
                        displaySuggestedTasks(data.suggested_tasks);
                    }
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æ›´æ–°ï¼ˆæ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ï¼‰
                    document.getElementById('session-id').value = sessionId;
                } else {
                    alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>

