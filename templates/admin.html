<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
    <span class="brand-title">ATD</span>
    <span class="brand-date">{{ current_date_display }}</span>
</div>
            <div class="navbar-menu">
                <a href="{{ url_for('main.dashboard') }}" class="navbar-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="{{ url_for('tasks.list_tasks') }}" class="navbar-item">ã‚¿ã‚¹ã‚¯ç®¡ç†</a>
                <a href="{{ url_for('main.mindmap') }}" class="navbar-item">ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</a>
                <a href="{{ url_for('main.personal_task_cards') }}" class="navbar-item">ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰</a>
                <a href="{{ url_for('main.admin') }}" class="navbar-item active">ç®¡ç†è€…</a>
                <a href="{{ url_for('main.profile') }}" class="navbar-item">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
            </div>
            <div class="user-controls">
                <a href="{{ url_for('main.notifications') }}" class="btn btn-sm" style="position: relative; margin-right: 5px;">
                    ğŸ””
                    {% if unread_notifications > 0 %}
                        <span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                <a href="#" class="user-control active personal-mode">
                    å€‹äºº
                </a>
                <a href="#" class="user-control">
                    ãƒãƒ¼ãƒ 
                </a>
                <a href="{{ url_for('main.profile') }}" class="user-control">
                    {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
            <p>ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çµ±è¨ˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</p>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ -->
        <div class="card">
            <div class="card-header">
                <h3>ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ total_users }}</div>
                    <div class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_tasks }}</div>
                    <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_teams }}</div>
                    <div class="stat-label">ç·ãƒãƒ¼ãƒ æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ active_users }}</div>
                    <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ7æ—¥é–“ï¼‰</div>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="card">
            <div class="card-header">
                <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            </div>
            <div style="padding: 1rem;">
                <p style="margin-bottom: 1rem;">å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚¿ã‚¹ã‚¯ã€ãƒãƒ¼ãƒ ã€ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãªã©ï¼‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚</p>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="exportData()">
                        ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <label for="importFile" class="btn btn-success" style="cursor: pointer; margin: 0;">
                        ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </label>
                </div>
                <div id="importStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
        </div>

        <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
        <div class="card">
            <div class="card-header">
                <h3>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h3>
            </div>
            <form id="createUserForm" style="padding: 1rem;">
                <div class="form-group">
                    <label for="new-username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å *</label>
                    <input type="text" id="new-username" name="username" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="new-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                    <input type="email" id="new-email" name="email" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="new-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="password" id="new-password" name="password" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="new-password-confirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *</label>
                    <input type="password" id="new-password-confirm" name="password_confirm" class="form-control" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="createUserBtn">æ–°è¦ä½œæˆ</button>
                    <button type="reset" class="btn btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </form>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
        <div class="card">
            <div class="card-header">
                <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
            </div>
            <div class="user-list">
                {% for user in all_users %}
                    <div class="user-card">
                        <div class="user-info">
                            <div class="user-basic">
                                <h4>
                                    {{ user.username }}
                                    {% if user.is_admin %}
                                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px;">ç®¡ç†è€…</span>
                                    {% endif %}
                                </h4>
                                <p class="user-email">{{ user.email }}</p>
                                <p class="user-joined">ç™»éŒ²æ—¥: {{ user.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</p>
                            </div>
                            <div class="user-stats">
                                <div class="stat-item">
                                    <span class="stat-label">ã‚¿ã‚¹ã‚¯æ•°:</span>
                                    <span class="stat-value">{{ user_stats[user.id].total_tasks }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å®Œäº†ç‡:</span>
                                    <span class="stat-value">{{ "%.1f"|format(user_stats[user.id].completion_rate) }}%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ãƒãƒ¼ãƒ æ•°:</span>
                                    <span class="stat-value">{{ user_stats[user.id].team_count }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é€£ç¶šæ—¥æ•°:</span>
                                    <span class="stat-value">{{ user_stats[user.id].streak_days }}æ—¥</span>
                                </div>
                                {% if user_stats[user.id].last_active %}
                                <div class="stat-item">
                                    <span class="stat-label">æœ€çµ‚æ´»å‹•:</span>
                                    <span class="stat-value">{{ user_stats[user.id].last_active.strftime('%m/%d') }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="user-actions">
                            {% if user.is_admin %}
                                <button class="btn btn-sm btn-warning" onclick="toggleAdmin({{ user.id }}, false)">ç®¡ç†è€…è§£é™¤</button>
                            {% else %}
                                <button class="btn btn-sm btn-success" onclick="toggleAdmin({{ user.id }}, true)">ç®¡ç†è€…ã«è¨­å®š</button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline" onclick="resetUserPassword({{ user.id }})">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})">å‰Šé™¤</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
    // ç®¡ç†è€…ãƒ•ãƒ©ã‚°ã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleAdmin(userId, isAdmin) {
        const action = isAdmin ? 'ç®¡ç†è€…ã«è¨­å®š' : 'ç®¡ç†è€…ã‚’è§£é™¤';
        if (confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
            fetch('/admin/toggle-admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    is_admin: isAdmin
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }
    }
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
    function resetUserPassword(userId) {
        const newPassword = prompt('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (newPassword === null || newPassword.trim() === '') {
            return;
        }
        
        const confirmPassword = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„:');
        if (confirmPassword === null || confirmPassword.trim() === '') {
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            return;
        }
        
        if (newPassword.length < 4) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }
        
        fetch('/admin/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: userId,
                new_password: newPassword.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                location.reload();
            } else {
                alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
    function deleteUser(userId) {
        if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¹ã‚¯ã€ãƒãƒ¼ãƒ æƒ…å ±ãªã©ï¼‰ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
            return;
        }
        
        // äºŒé‡ç¢ºèª
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            return;
        }
        
        fetch('/admin/delete-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                location.reload();
            } else {
                alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    }
    
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    document.getElementById('createUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('createUserBtn');
        btn.disabled = true;
        btn.textContent = 'ä½œæˆä¸­...';
        
        const formData = {
            username: document.getElementById('new-username').value,
            email: document.getElementById('new-email').value,
            password: document.getElementById('new-password').value,
            password_confirm: document.getElementById('new-password-confirm').value
        };
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
        if (formData.password !== formData.password_confirm) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            btn.disabled = false;
            btn.textContent = 'æ–°è¦ä½œæˆ';
            return;
        }
        
        fetch('/admin/create-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                document.getElementById('createUserForm').reset();
                location.reload();
            } else {
                alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'æ–°è¦ä½œæˆ';
        });
    });

    // å€‹äºº/ãƒãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.user-control').forEach(control => {
        control.addEventListener('click', function(e) {
            if (this.textContent.trim() === 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«' || this.textContent.trim() === '{% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}') {
                return; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã¯ãã®ã¾ã¾é·ç§»
            }
            e.preventDefault();
            document.querySelectorAll('.user-control').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const mode = this.textContent.trim();
            if (mode === 'ãƒãƒ¼ãƒ ') {
                window.location.href = '/team-management';
            }
        });
    });

    // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportData() {
        if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
            return;
        }
        
        window.location.href = '/admin/export-data';
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importData(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        if (!confirm('ç¾åœ¨ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
            event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const statusDiv = document.getElementById('importStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<p style="color: #666;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...</p>';

        fetch('/admin/import-data', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = '<p style="color: #28a745; font-weight: bold;">âœ“ ' + data.message + '</p>';
                setTimeout(() => {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                    location.reload();
                }, 1000);
            } else {
                statusDiv.innerHTML = '<p style="color: #dc3545; font-weight: bold;">âœ— ' + (data.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ') + '</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.innerHTML = '<p style="color: #dc3545; font-weight: bold;">âœ— ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
        })
        .finally(() => {
            event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        });
    }
    </script>
</body>
</html>
