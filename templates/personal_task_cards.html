<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .mindmap-container {
            background: white;
            padding: 24px;
        }

        .taskcard-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toolbar-left label {
            font-weight: 600;
            color: #333;
        }

        .progress-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .mindmap-columns {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .mindmap-column {
            flex: 0 0 320px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .mindmap-card {
            background: white;
            border-radius: 18px;
            box-shadow: 0 8px 28px rgba(15, 23, 42, 0.12);
            padding: 18px;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(15, 23, 42, 0.06);
        }

        .mindmap-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
        }

        .mindmap-card.root-node {
            border-left: 5px solid #006400;
        }

        .mindmap-card.level-1 {
            border-left: 5px solid #4CAF50;
        }

        .mindmap-card.level-2 {
            border-left: 5px solid #8BC34A;
        }

        .mindmap-card.level-3 {
            border-left: 5px solid #CDDC39;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: #0f172a;
            cursor: pointer;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .card-actions button {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: white;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .card-actions button:hover {
            background: rgba(0, 139, 139, 0.08);
            color: #006400;
        }

        .card-actions button.danger:hover {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .card-description {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.5;
        }

        .card-stats {
            margin-top: 15px;
        }

        .progress-label {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s ease;
        }

        .card-meta {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: #475569;
        }

        .card-meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .task-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(0, 139, 139, 0.12);
            color: #006064;
            font-weight: 600;
        }

        .task-badge.completed {
            background: rgba(34, 197, 94, 0.15);
            color: #166534;
        }

        .child-nodes {
            margin-top: 15px;
            border-top: 1px dashed rgba(148, 163, 184, 0.4);
            padding-top: 12px;
            display: none;
        }

        .child-nodes.expanded {
            display: block;
        }

        .child-list-item {
            padding: 6px 0;
            font-size: 13px;
            color: #475569;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #94a3b8;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #node-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 18px;
            padding: 24px;
            width: min(520px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-actions .btn {
            flex: 1;
        }

        @media (max-width: 900px) {
            .mindmap-columns {
                flex-direction: column;
            }
            .mindmap-column {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
    <span class="brand-title">ATD</span>
    <span class="brand-date">{{ current_date_display }}</span>
</div>
            <div class="navbar-menu">
                        <a href="{{ url_for('main.dashboard') }}" class="navbar-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                        <a href="{{ url_for('tasks.list_tasks') }}" class="navbar-item">ã‚¿ã‚¹ã‚¯ç®¡ç†</a>
                        <a href="{{ url_for('main.mindmap') }}" class="navbar-item">ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</a>
                        <a href="{{ url_for('main.personal_task_cards') }}" class="navbar-item active">ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰</a>
                        {% if current_user.is_admin %}
                            <a href="{{ url_for('main.admin') }}" class="navbar-item">ç®¡ç†è€…</a>
                        {% endif %}
                <a href="{{ url_for('main.profile') }}" class="navbar-item">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
            </div>
            <div class="user-controls">
                <a href="{{ url_for('main.notifications') }}" class="btn btn-sm" style="position: relative; margin-right: 5px;">
                    ğŸ””
                    {% if unread_notifications > 0 %}
                        <span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                <a href="#" class="user-control active personal-mode">
                    å€‹äºº
                </a>
                <a href="#" class="user-control">
                    ãƒãƒ¼ãƒ 
                </a>
                <a href="{{ url_for('main.profile') }}" class="user-control">
                    {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰</h1>
            <p style="color:#64748b;margin-top:6px;">å€‹äººã®ç›®æ¨™ã‚„ã‚¿ã‚¹ã‚¯ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã§æ•´ç†ã—ã€ã‚¿ã‚¹ã‚¯ç®¡ç†ã¨é€£æºã§ãã¾ã™ã€‚</p>
        </div>

        <div class="card">
            <div class="taskcard-toolbar">
                <div class="toolbar-left">
                    <label for="mindmap-selector">ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰</label>
                    <select id="mindmap-selector" class="form-control" style="min-width:220px;"></select>
                    <span class="progress-indicator">é”æˆåº¦: <span id="progress-value">0</span>%</span>
                </div>
                <div class="toolbar-right">
                    <button class="btn btn-secondary btn-sm" id="reload-btn">å†èª­ã¿è¾¼ã¿</button>
                    <button class="btn btn-primary btn-sm" id="create-map-btn">æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ä½œæˆ</button>
                </div>
            </div>
        </div>

        <div class="card mindmap-container">
            <div id="mindmap-list" class="mindmap-columns"></div>
        </div>
    </div>

    <div id="node-modal">
        <div class="modal-content">
            <h3 id="modal-title">ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†</h3>
            <div class="form-group">
                <label for="node-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="node-title" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="node-description">èª¬æ˜</label>
                <textarea id="node-description" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="node-due-date">å®Œäº†äºˆå®šæ—¥</label>
                <input type="date" id="node-due-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="node-progress">é€²æ—ç‡ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚¿ã‚¹ã‚¯ã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼‰</label>
                <input type="number" id="node-progress" class="form-control" readonly>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                <label style="margin:0;">
                    <input type="checkbox" id="node-is-task">
                    ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ç®¡ç†ã™ã‚‹
                </label>
                <label style="margin:0;">
                    <input type="checkbox" id="node-completed">
                    ãƒãƒ¼ãƒ‰å®Œäº†
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="save-node-btn">ä¿å­˜</button>
                <button class="btn btn-secondary" id="cancel-node-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" id="delete-node-btn" style="display:none;">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <script>
        let mindmapId = null;
        let nodes = [];
        let expandedNodes = new Set();
        let editingNodeId = null;

        const selector = document.getElementById('mindmap-selector');
        const mindmapList = document.getElementById('mindmap-list');
        const progressValue = document.getElementById('progress-value');

        document.getElementById('reload-btn').addEventListener('click', () => {
            if (mindmapId) {
                loadTaskCards(mindmapId);
            } else {
                loadMindmapList(true);
            }
        });

        document.getElementById('create-map-btn').addEventListener('click', async () => {
            const name = prompt('ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰');
            if (name === null) return;
            const suggestedDate = new Date().toISOString().slice(0, 10);
            const dateInput = prompt('ç®¡ç†æ—¥ï¼ˆYYYY-MM-DDï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰', suggestedDate) || '';

            try {
                const response = await fetch('/personal/mindmap/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, date: dateInput })
                });
                const data = await response.json();
                if (data.success) {
                    mindmapId = data.mindmap_id;
                    expandedNodes.clear();
                    await loadMindmapList(true);
                    await loadTaskCards(mindmapId);
                } else {
                    alert('ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error creating mindmap:', error);
                alert('ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        selector.addEventListener('change', async (event) => {
            const selected = event.target.value;
            mindmapId = selected ? Number(selected) : null;
            expandedNodes.clear();
            await loadTaskCards(mindmapId);
        });

        async function loadMindmapList(force = false) {
            try {
                const response = await fetch('/personal/mindmaps');
                const data = await response.json();
                const mindmaps = data.mindmaps || [];

                selector.innerHTML = '';
                if (mindmaps.length === 0) {
                    selector.innerHTML = '<option value="">ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</option>';
                    mindmapId = null;
                    mindmapList.innerHTML = '<div class="empty-state">æœ€åˆã®ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>';
                    progressValue.textContent = '0';
                    return;
                }

                mindmaps.forEach(map => {
                    const option = document.createElement('option');
                    option.value = map.id;
                    const dateLabel = map.date ? ` (${map.date})` : '';
                    option.textContent = `${map.name}${dateLabel}`;
                    selector.appendChild(option);
                });

                if (!mindmapId || force) {
                    mindmapId = mindmaps[0].id;
                }
                selector.value = mindmapId;
            } catch (error) {
                console.error('Error loading mindmap list:', error);
                mindmapList.innerHTML = '<div class="empty-state">ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
            }
        }

        async function loadTaskCards(mid = null) {
            try {
                const url = mid ? `/personal/mindmap/nodes?mindmap_id=${mid}` : '/personal/mindmap/nodes';
                const response = await fetch(url);
                const data = await response.json();
                nodes = data.nodes || [];
                mindmapId = data.mindmap_id || mid || mindmapId;

                // å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒ‰IDã‚’expandedã‚»ãƒƒãƒˆã‹ã‚‰é™¤å¤–
                const validIds = new Set(nodes.map(node => node.id));
                expandedNodes = new Set(Array.from(expandedNodes).filter(id => validIds.has(id)));

                renderMindmap();
                updateProgress();
            } catch (error) {
                console.error('Error loading task cards:', error);
                mindmapList.innerHTML = '<div class="empty-state">ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
            }
        }

        async function updateProgress() {
            if (!mindmapId) {
                progressValue.textContent = '0';
                return;
            }
            try {
                const response = await fetch(`/personal/mindmap/progress?mindmap_id=${mindmapId}`);
                const data = await response.json();
                progressValue.textContent = data.progress ?? 0;
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        function renderMindmap() {
            mindmapList.innerHTML = '';

            if (!mindmapId) {
                mindmapList.innerHTML = '<div class="empty-state">ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
                return;
            }

            if (!nodes || nodes.length === 0) {
                mindmapList.innerHTML = '<div class="empty-state">ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            const nodeMap = new Map();
            nodes.forEach(node => {
                nodeMap.set(node.id, node);
            });

            const levelGroups = {};
            nodes.forEach(node => {
                let level = 0;
                let current = node;
                while (current.parent_id) {
                    level++;
                    current = nodeMap.get(current.parent_id);
                    if (!current) break;
                }
                if (!levelGroups[level]) levelGroups[level] = [];
                levelGroups[level].push(node);
            });

            const sortedLevels = Object.keys(levelGroups).sort((a, b) => a - b);
            sortedLevels.forEach(level => {
                const column = document.createElement('div');
                column.className = 'mindmap-column';
                levelGroups[level].forEach(node => renderCard(column, node));
                mindmapList.appendChild(column);
            });
        }

        function isNodeExpanded(nodeId) {
            return expandedNodes.has(nodeId);
        }

        function toggleExpanded(nodeId) {
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            renderMindmap();
        }

        function renderCard(container, node) {
            const card = document.createElement('div');
            card.className = 'mindmap-card';
            card.dataset.nodeId = node.id;

            // assign level class
            let level = 0;
            let current = node;
            const nodeMap = new Map();
            nodes.forEach(n => nodeMap.set(n.id, n));
            while (current.parent_id) {
                level++;
                current = nodeMap.get(current.parent_id);
                if (!current) break;
            }
            if (level === 0) card.classList.add('root-node');
            if (level === 1) card.classList.add('level-1', 'child-node');
            if (level === 2) card.classList.add('level-2', 'child-node');
            if (level >= 3) card.classList.add('level-3', 'child-node');

            const header = document.createElement('div');
            header.className = 'card-header';

            const title = document.createElement('div');
            title.className = 'card-title';
            title.textContent = node.title || 'ç„¡é¡Œ';
            title.onclick = () => showEditModal(node);

            const actions = document.createElement('div');
            actions.className = 'card-actions';

            const children = nodes.filter(n => n.parent_id === node.id);
            if (children.length > 0) {
                const expandBtn = document.createElement('button');
                expandBtn.textContent = isNodeExpanded(node.id) ? 'âˆ’' : '+';
                expandBtn.title = isNodeExpanded(node.id) ? 'å­ã‚«ãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã‚€' : 'å­ã‚«ãƒ¼ãƒ‰ã‚’å±•é–‹';
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleExpanded(node.id);
                };
                actions.appendChild(expandBtn);
            }

            const addBtn = document.createElement('button');
            addBtn.textContent = '+å­ã‚«ãƒ¼ãƒ‰';
            addBtn.title = 'å­ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ';
            addBtn.onclick = (e) => {
                e.stopPropagation();
                showAddNodeModal(node.id);
            };
            actions.appendChild(addBtn);

            const detailBtn = document.createElement('button');
            detailBtn.textContent = 'è©³ç´°';
            detailBtn.title = 'ã‚«ãƒ¼ãƒ‰è©³ç´°ã‚’é–‹ã';
            detailBtn.onclick = (e) => {
                e.stopPropagation();
                window.location.href = `/personal/task-cards/${node.id}`;
            };
            actions.appendChild(detailBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'ç·¨é›†';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                showEditModal(node);
            };
            actions.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.classList.add('danger');
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                if (!confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå­ã‚«ãƒ¼ãƒ‰ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
                await deleteNode(node.id);
            };
            actions.appendChild(deleteBtn);

            header.appendChild(title);
            header.appendChild(actions);
            card.appendChild(header);

            if (node.description) {
                const desc = document.createElement('div');
                desc.className = 'card-description';
                desc.textContent = node.description;
                card.appendChild(desc);
            }

            const stats = document.createElement('div');
            stats.className = 'card-stats';
            stats.innerHTML = `
                <div class="progress-label">
                    <span>é€²æ—ç‡</span>
                    <span>${node.progress || 0}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${node.progress || 0}%"></div>
                </div>
            `;
            card.appendChild(stats);

            const meta = document.createElement('div');
            meta.className = 'card-meta';
            if (node.due_date) {
                meta.innerHTML += `<span>ğŸ—“ ${node.due_date}</span>`;
            }
            if (node.completed) {
                meta.innerHTML += `<span>âœ… å®Œäº†æ¸ˆã¿</span>`;
            }
            if (node.task_count > 0) {
                meta.innerHTML += `<span>ğŸ“ ã‚¿ã‚¹ã‚¯ ${node.completed_task_count}/${node.task_count}</span>`;
            }
            card.appendChild(meta);

            if (node.task_count > 0) {
                const taskBadge = document.createElement('div');
                const completedAll = node.completed_task_count === node.task_count;
                taskBadge.className = 'task-badge' + (completedAll ? ' completed' : '');
                taskBadge.textContent = completedAll
                    ? 'ã‚«ãƒ¼ãƒ‰å†…ã‚¿ã‚¹ã‚¯å®Œäº†'
                    : `ã‚«ãƒ¼ãƒ‰å†…ã‚¿ã‚¹ã‚¯ ${node.completed_task_count}/${node.task_count}`;
                card.appendChild(taskBadge);
            } else if (node.is_task) {
                const taskBadge = document.createElement('div');
                taskBadge.className = 'task-badge' + (node.task_completed ? ' completed' : '');
                taskBadge.textContent = node.task_completed ? 'ã‚¿ã‚¹ã‚¯å®Œäº†æ¸ˆã¿' : 'ã‚¿ã‚¹ã‚¯ã¨é€£æºä¸­';
                card.appendChild(taskBadge);
            }

            const taskActions = document.createElement('div');
            taskActions.className = 'card-actions';
            taskActions.style.marginTop = '12px';
            taskActions.style.flexWrap = 'wrap';

            if (node.is_task && node.task_id) {
                const openBtn = document.createElement('button');
                openBtn.textContent = 'ã‚¿ã‚¹ã‚¯ã‚’é–‹ã';
                openBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.open(`/tasks/${node.task_id}/edit`, '_blank');
                };
                taskActions.appendChild(openBtn);

                const unlinkBtn = document.createElement('button');
                unlinkBtn.textContent = 'ãƒªãƒ³ã‚¯è§£é™¤';
                unlinkBtn.classList.add('danger');
                unlinkBtn.onclick = async (e) => {
                    e.stopPropagation();
                    await detachTaskFromCard(node);
                };
                taskActions.appendChild(unlinkBtn);
            } else {
                const prepareBtn = document.createElement('button');
                prepareBtn.textContent = node.is_task ? 'ã‚¿ã‚¹ã‚¯æœªä½œæˆ' : 'ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰åŒ–';
                prepareBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!node.is_task) {
                        await updateNode(node.id, { is_task: true }, { silent: true });
                    }
                    await createTaskFromCard(node.id);
                };
                taskActions.appendChild(prepareBtn);
            }

            if (taskActions.children.length > 0) {
                card.appendChild(taskActions);
            }

            if (children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'child-nodes';
                if (isNodeExpanded(node.id)) {
                    childContainer.classList.add('expanded');
                }
                children.forEach(child => {
                    const item = document.createElement('div');
                    item.className = 'child-list-item';
                    item.textContent = `â€¢ ${child.title || 'ç„¡é¡Œ'}`;
                    childContainer.appendChild(item);
                });
                card.appendChild(childContainer);
            }

            container.appendChild(card);
        }

        function showAddNodeModal(parentId = null) {
            editingNodeId = null;
            document.getElementById('modal-title').textContent = parentId ? 'å­ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ' : 'ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ';
            document.getElementById('node-title').value = '';
            document.getElementById('node-description').value = '';
            document.getElementById('node-due-date').value = '';
            document.getElementById('node-progress').value = '0';
            document.getElementById('node-is-task').checked = parentId ? false : true;
            document.getElementById('node-completed').checked = false;
            document.getElementById('delete-node-btn').style.display = 'none';

            const modal = document.getElementById('node-modal');
            modal.dataset.parentId = parentId || '';
            modal.style.display = 'block';
        }

        function showEditModal(node) {
            editingNodeId = node.id;
            document.getElementById('modal-title').textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†';
            document.getElementById('node-title').value = node.title || '';
            document.getElementById('node-description').value = node.description || '';
            document.getElementById('node-due-date').value = node.due_date || '';
            document.getElementById('node-progress').value = node.progress || 0;
            document.getElementById('node-is-task').checked = !!node.is_task;
            document.getElementById('node-completed').checked = !!node.completed;
            document.getElementById('delete-node-btn').style.display = 'inline-block';

            const modal = document.getElementById('node-modal');
            modal.dataset.parentId = '';
            modal.style.display = 'block';
        }

        document.getElementById('cancel-node-btn').addEventListener('click', () => {
            document.getElementById('node-modal').style.display = 'none';
            editingNodeId = null;
        });

        document.getElementById('delete-node-btn').addEventListener('click', async () => {
            if (!editingNodeId) return;
            if (!confirm('ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            await deleteNode(editingNodeId);
            document.getElementById('node-modal').style.display = 'none';
            editingNodeId = null;
        });

        document.getElementById('save-node-btn').addEventListener('click', async () => {
            const title = document.getElementById('node-title').value.trim();
            if (!title) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const payload = {
                title,
                description: document.getElementById('node-description').value,
                due_date: document.getElementById('node-due-date').value || null,
                completed: document.getElementById('node-completed').checked,
                is_task: document.getElementById('node-is-task').checked
            };

            try {
                let response;
                if (editingNodeId) {
                    response = await fetch(`/personal/mindmap/nodes/${editingNodeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    const parentId = document.getElementById('node-modal').dataset.parentId || null;
                    const url = mindmapId ? `/personal/mindmap/nodes?mindmap_id=${mindmapId}` : '/personal/mindmap/nodes';
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...payload,
                            parent_id: parentId ? Number(parentId) : null
                        })
                    });
                }

                const data = await response.json();
                if (data.success) {
                    document.getElementById('node-modal').style.display = 'none';
                    editingNodeId = null;
                    await loadTaskCards(mindmapId);
                } else {
                    alert('ã‚«ãƒ¼ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error saving node:', error);
                alert('ã‚«ãƒ¼ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        function suggestCategory(node) {
            if (!node.due_date) return 'other';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(node.due_date);
            due.setHours(0, 0, 0, 0);
            const diff = (due - today) / (1000 * 60 * 60 * 24);
            if (diff <= 0) return 'today';
            if (diff === 1) return 'tomorrow';
            return 'other';
        }

        async function createTaskFromCard(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) {
                alert('ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            const category = 'other';

            let priority = prompt('å„ªå…ˆåº¦ (high / medium / low)', 'medium');
            if (priority === null) return;
            priority = priority.trim().toLowerCase();

            try {
                const response = await fetch(`/personal/mindmap/nodes/${nodeId}/create-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category, priority })
                });
                const data = await response.json();
                if (data.success) {
                    alert('ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    await loadTaskCards(mindmapId);
                } else {
                    alert(data.error || data.message || 'ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error creating task from card:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function detachTaskFromCard(node) {
            if (!confirm('ã‚¿ã‚¹ã‚¯ã¨ã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿã‚¿ã‚¹ã‚¯ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
            await updateNode(node.id, { is_task: false });
        }

        async function updateNode(nodeId, payload, options = {}) {
            try {
                const response = await fetch(`/personal/mindmap/nodes/${nodeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.success) {
                    await loadTaskCards(mindmapId);
                } else {
                    if (!options.silent) {
                        alert('ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('Error updating node:', error);
                if (!options.silent) {
                    alert('ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        async function deleteNode(nodeId) {
            try {
                const response = await fetch(`/personal/mindmap/nodes/${nodeId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    await loadTaskCards(mindmapId);
                } else {
                    alert('ã‚«ãƒ¼ãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error deleting node:', error);
                alert('ã‚«ãƒ¼ãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('node-modal').addEventListener('click', (event) => {
            if (event.target.id === 'node-modal') {
                document.getElementById('node-modal').style.display = 'none';
                editingNodeId = null;
            }
        });

        (async function init() {
            await loadMindmapList();
            if (mindmapId) {
                await loadTaskCards(mindmapId);
            }
        })();
    </script>
</body>
</html>

