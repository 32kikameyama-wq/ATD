<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉÅ„Éº„É†ÁÆ°ÁêÜ - ATD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ‰∏äÈÉ®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
    <span class="brand-title">ATD</span>
    <span class="brand-date">{{ current_date_display }}</span>
</div>
            <div class="navbar-menu">
                <a href="{{ url_for('main.team_management') }}" class="navbar-item active">„ÉÅ„Éº„É†</a>
                <a href="{{ url_for('main.team_mindmap') }}" class="navbar-item">„ÉÅ„Éº„É†ÁõÆÊ®ô</a>
                <a href="{{ url_for('main.team_tasks') }}" class="navbar-item">„ÉÅ„Éº„É†„Çø„Çπ„ÇØ</a>
                <a href="{{ url_for('main.personal_task_cards') }}" class="navbar-item">„Çø„Çπ„ÇØ„Ç´„Éº„Éâ</a>
            </div>
            <div class="user-controls">
                <a href="{{ url_for('main.notifications') }}" class="btn btn-sm" style="position: relative; margin-right: 5px;">
                    üîî
                    {% if unread_notifications > 0 %}
                        <span style="position: absolute; top: -5px; right: -5px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
                <a href="{{ url_for('main.dashboard') }}" class="user-control">
                    ÂÄã‰∫∫
                </a>
                <a href="#" class="user-control active team-mode">
                    „ÉÅ„Éº„É†
                </a>
                <a href="{{ url_for('main.profile') }}" class="user-control">
                    {% if current_user.display_name %}{{ current_user.display_name }}{% else %}{{ current_user.username }}{% endif %}
                </a>
            </div>
        </div>
    </nav>

    <div class="container">

        <div class="page-header">
            <h1>„ÉÅ„Éº„É†ÁÆ°ÁêÜ</h1>
            <a href="{{ url_for('main.create_team') }}" class="btn btn-primary">+ Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†</a>
        </div>

        <div class="team-management-grid">
                <!-- Â∑¶„Ç´„É©„É† -->
                <div class="team-left">
                    <!-- „ÉÅ„Éº„É†ÂÖ®‰Ωì -->
                    <div class="team-section" style="min-height: 400px;">
                        <div class="section-header">
                            <h3>„Éª„ÉÅ„Éº„É†ÂÖ®‰Ωì</h3>
                        </div>
                        <div class="team-stats-card" style="display: flex; align-items: center; justify-content: center; height: calc(100% - 60px); gap: 10px;">
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ "%.1f"|format(overall_progress) }}%</div>
                                <div class="stat-text">ÂÆå‰∫ÜÁéá</div>
                            </div>
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ overall_total_tasks }}</div>
                                <div class="stat-text">„Çø„Çπ„ÇØÊï∞</div>
                            </div>
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ overall_completed_tasks }}</div>
                                <div class="stat-text">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
                            </div>
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ total_teams }}</div>
                                <div class="stat-text">ÊâÄÂ±û„ÉÅ„Éº„É†</div>
                            </div>
                        </div>
                    </div>

                    <!-- „ÉÅ„Éº„É†‰∏ÄË¶ß -->
                    <div class="team-section" style="margin-top: 1.5rem; min-height: 400px;">
                        <div class="section-header">
                            <h3>„ÉªÊâÄÂ±û„ÉÅ„Éº„É†</h3>
                        </div>
                        <div class="team-tasks-content" style="display: flex; flex-direction: column; height: 100%;">
                            {% if user_teams %}
                                {% for team in user_teams %}
                                    <div class="team-card">
                                        <div class="team-info">
                                            <h4>{{ team.name }}</h4>
                                            {% if team.description %}
                                                <p>{{ team.description }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="team-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">„ÉÅ„Éº„É†„Çø„Çπ„ÇØÊï∞</span>
                                                <span class="stat-value">{{ team_stats[team.id].total }}‰ª∂</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</span>
                                                <span class="stat-value">{{ team_stats[team.id].completed }}‰ª∂</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">ÂÆå‰∫ÜÁéá</span>
                                                <span class="stat-value">{{ "%.1f"|format(team_stats[team.id].completion_rate) }}%</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">„É°„É≥„Éê„ÉºÊï∞</span>
                                                <span class="stat-value">{{ team_stats[team.id].member_count }}‰∫∫</span>
                                            </div>
                                        </div>
                                        <div class="team-actions">
                                            <a href="{{ url_for('main.team_dashboard', team_id=team.id) }}" class="btn btn-primary">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>
                                            {% if team_stats[team.id].is_admin %}
                                                <a href="{{ url_for('main.edit_team', team_id=team.id) }}" class="btn btn-secondary">Á∑®ÈõÜ</a>
                                            {% endif %}
                                            <a href="{{ url_for('main.add_team_member', team_id=team.id) }}" class="btn btn-secondary">„É°„É≥„Éê„ÉºËøΩÂä†</a>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-teams">
                                    <p>ÊâÄÂ±û„Åó„Å¶„ÅÑ„Çã„ÉÅ„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <a href="{{ url_for('main.create_team') }}" class="btn btn-primary">„ÉÅ„Éº„É†„Çí‰ΩúÊàê</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Âè≥„Ç´„É©„É† -->
                <div class="team-right">
                    <!-- „ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂÖ®‰Ωì -->
                    <div class="team-section" style="min-height: 400px;">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>„Éª„ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂÖ®‰Ωì</h3>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label for="team-select-personal" style="font-size: 0.75rem; color: var(--text-secondary);">„ÉÅ„Éº„É†:</label>
                                <select id="team-select-personal" onchange="updatePersonalTeam()" style="padding: 3px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.75rem; min-width: 150px;">
                                    <option value="">-- „ÉÅ„Éº„É†„ÇíÈÅ∏Êäû --</option>
                                    {% for team in user_teams %}
                                        <option value="{{ team.id }}" {% if selected_team_id == team.id %}selected{% endif %}>{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="team-stats-card" style="display: flex; align-items: center; justify-content: center; height: calc(100% - 60px); gap: 10px;">
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ "%.1f"|format(personal_progress_percentage) }}%</div>
                                <div class="stat-text">ÂÆå‰∫ÜÁéá</div>
                            </div>
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ personal_total_tasks }}</div>
                                <div class="stat-text">„Çø„Çπ„ÇØÊï∞</div>
                            </div>
                            <div class="stat-box" style="flex: 1; margin: 0;">
                                <div class="stat-number">{{ personal_completed_tasks }}</div>
                                <div class="stat-text">ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞</div>
                            </div>
                        </div>
                    </div>

                    <!-- „É°„É≥„Éê„ÉºÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ -->
                    <div class="team-section" style="margin-top: 1.5rem; min-height: 400px;">
                        <div class="section-header">
                            <h3>„Éª„É°„É≥„Éê„ÉºÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h3>
                        </div>
                        <div class="member-performance-content" style="display: flex; flex-direction: column; height: 100%;">
                            {% if user_teams %}
                                <div style="margin-bottom: 1rem;">
                                    <label for="team-select" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-primary);">„ÉÅ„Éº„É†„ÇíÈÅ∏Êäû:</label>
                                    <select id="team-select" class="form-control" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="">-- „ÉÅ„Éº„É†„ÇíÈÅ∏Êäû --</option>
                                        {% for team in user_teams %}
                                            <option value="{{ team.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="members-list" style="flex: 1; overflow-y: auto;">
                                    <p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">
                                        ‰∏äË®ò„Åã„Çâ„ÉÅ„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                                    </p>
                                </div>
                            {% else %}
                                <p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">
                                    ÊâÄÂ±û„Åó„Å¶„ÅÑ„Çã„ÉÅ„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // „ÉÅ„Éº„É†ÈÅ∏ÊäûÊôÇ„ÅÆ„É°„É≥„Éê„Éº‰∏ÄË¶ßË°®Á§∫
        const teamSelect = document.getElementById('team-select');
        if (teamSelect) {
            teamSelect.addEventListener('change', function() {
            const teamId = this.value;
            const membersList = document.getElementById('members-list');
            
            if (!teamId) {
                membersList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">‰∏äË®ò„Åã„Çâ„ÉÅ„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            membersList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
            
            // „É°„É≥„Éê„Éº‰∏ÄË¶ß„ÇíÂèñÂæó
            fetch(`/team/${teamId}/members`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.members.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                        data.members.forEach(member => {
                            html += `
                                <div style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                            <span style="display: inline-block; padding: 0.2rem 0.6rem; background: ${member.role === 'admin' ? '#ff9800' : '#2196F3'}; color: white; border-radius: 12px; font-size: 0.75rem; margin-right: 0.5rem;">${member.role === 'admin' ? 'ÁÆ°ÁêÜËÄÖ' : '„É°„É≥„Éê„Éº'}</span>
                                            ${member.display_name || member.username}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #666;">
                                            ÂÆå‰∫ÜÁéá: ${member.completion_rate.toFixed(1)}% | „Çø„Çπ„ÇØ: ${member.total_tasks}‰ª∂
                                        </div>
                                    </div>
                                    <a href="/member/${member.user_id}/detail?team_id=${teamId}" class="btn btn-sm btn-primary">Ë©≥Á¥∞</a>
                                </div>
                            `;
                        });
                        html += '</div>';
                        membersList.innerHTML = html;
                    } else {
                        membersList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">„É°„É≥„Éê„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    membersList.innerHTML = '<p style="color: #f44336; text-align: center; padding: 2rem;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
                });
            });
        }
        
        // ÂÄã‰∫∫/„ÉÅ„Éº„É†Âàá„ÇäÊõø„Åà
        document.querySelectorAll('.user-control').forEach(control => {
            control.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.user-control').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const mode = this.textContent.trim();
                console.log('Âàá„ÇäÊõø„Åà:', mode);
                
                if (mode === 'ÂÄã‰∫∫') {
                    // ÂÄã‰∫∫„É¢„Éº„Éâ„Å´ÈÅ∑Áßª
                    window.location.href = '/dashboard';
                } else if (mode === '„ÉÅ„Éº„É†') {
                    // „ÉÅ„Éº„É†„É¢„Éº„Éâ - Êó¢„Å´„ÉÅ„Éº„É†„Éö„Éº„Ç∏„Å´„ÅÑ„Çã„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                }
            });
        });


        // „ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂÖ®‰Ωì„ÅÆ„ÉÅ„Éº„É†ÈÅ∏Êäû
        function updatePersonalTeam() {
            const teamId = document.getElementById('team-select-personal').value;
            const url = new URL(window.location.href);
            if (teamId) {
                url.searchParams.set('selected_team_id', teamId);
            } else {
                url.searchParams.delete('selected_team_id');
            }
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
