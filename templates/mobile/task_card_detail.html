{% extends 'mobile/base.html' %}
{% block head_title %}ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è©³ç´° - ATD Mobile{% endblock %}
{% set active_tab = 'tasks' %}

{% block header_profile %}
<div class="mobile-profile-card">
    <div class="mobile-profile-avatar">ğŸ—’ï¸</div>
    <div class="mobile-profile-info">
        <div class="mobile-profile-name">{{ card_node.title }}</div>
        <div class="mobile-status-input">ã‚«ãƒ¼ãƒ‰å†…ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒ¢ãƒã‚¤ãƒ«ã§ç®¡ç†</div>
    </div>
</div>
{% endblock %}

{% block content %}
<section class="mobile-section">
    <div class="mobile-section-actions">
        <a href="{{ url_for('main.mobile_task_cards') }}" class="mobile-action-chip">ä¸€è¦§ã¸æˆ»ã‚‹</a>
        <a href="{{ url_for('main.mobile_mindmap') }}" class="mobile-action-chip">ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹</a>
    </div>

    <div class="mobile-card">
        <div class="mobile-card-header">
            <div>
                <div class="mobile-card-title">{{ card_node.title }}</div>
                {% if card_node.description %}
                <div class="mobile-card-description">{{ card_node.description }}</div>
                {% endif %}
            </div>
            <div class="mobile-progress">
                <span>{{ card_node.progress or 0 }}%</span>
                <div class="mobile-progress-bar">
                    <div class="mobile-progress-fill" style="width: {{ card_node.progress or 0 }}%"></div>
                </div>
            </div>
        </div>
        <div class="mobile-card-meta">
            {% if card_node.due_date %}
            <span>ğŸ—“ {{ card_node.due_date.strftime('%Y/%m/%d') }}</span>
            {% endif %}
            <span>ã‚¿ã‚¹ã‚¯ {{ active_tasks|length + completed_tasks|length }} ä»¶</span>
            <span>é€²æ— {{ card_node.completed_task_count or 0 }}/{{ card_node.task_count or 0 }}</span>
        </div>
    </div>
</section>

<section class="mobile-section">
    <div class="mobile-section-title">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </div>
    <div class="mobile-form-card">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mobile-alert-group">
                {% for category, message in messages %}
                <div class="mobile-alert mobile-alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('main.add_personal_task_card_task', node_id=card_node.id) }}" method="post" class="mobile-form">
            <input type="hidden" name="next" value="{{ url_for('main.mobile_task_card_detail', node_id=card_node.id) }}">
            <div class="mobile-form-group">
                <label for="card-task-title" class="mobile-form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                <input type="text" id="card-task-title" name="title" class="mobile-form-input" placeholder="ã‚¿ã‚¹ã‚¯å" required>
            </div>
            <div class="mobile-form-group">
                <label for="card-task-description" class="mobile-form-label">èª¬æ˜</label>
                <textarea id="card-task-description" name="description" class="mobile-form-textarea" rows="3" placeholder="è©³ç´°ã‚„ãƒ¡ãƒ¢"></textarea>
            </div>
            <div class="mobile-form-row">
                <div class="mobile-form-group">
                    <label for="card-task-due" class="mobile-form-label">å®Œäº†äºˆå®šæ—¥</label>
                    <input type="date" id="card-task-due" name="due_date" class="mobile-form-input">
                </div>
                <div class="mobile-form-group">
                    <label for="card-task-priority" class="mobile-form-label">å„ªå…ˆåº¦</label>
                    <select id="card-task-priority" name="priority" class="mobile-form-input">
                        <option value="high">é«˜</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="low">ä½</option>
                    </select>
                </div>
            </div>
            <p class="mobile-form-note">ä½œæˆã—ãŸã‚¿ã‚¹ã‚¯ã¯è‡ªå‹•çš„ã«ã€Œãã®ä»–ã€ã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚</p>
            <div class="mobile-form-actions">
                <button type="submit" class="mobile-primary-button">è¿½åŠ ã™ã‚‹</button>
            </div>
        </form>
    </div>
</section>

<section class="mobile-section">
    <div class="mobile-section-title">æœªå®Œäº†ã‚¿ã‚¹ã‚¯ ({{ active_tasks|length }}ä»¶)</div>
    {% if active_tasks %}
    <div class="mobile-task-list">
        {% for task in active_tasks %}
        <div class="mobile-task-card">
            <div class="mobile-task-head">
                <div>
                    <div class="mobile-task-title">{{ task.title }}</div>
                    <div class="mobile-task-meta">
                        {% if task.end_date %}æœŸé™ {{ task.end_date.strftime('%m/%d') }} ãƒ»{% endif %} å„ªå…ˆåº¦ {{ 'é«˜' if task.priority=='high' else 'ä¸­' if task.priority=='medium' else 'ä½' }}
                    </div>
                    {% if task.description %}
                    <div class="mobile-task-desc">{{ task.description }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="mobile-task-buttons">
                <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_task_card_detail', node_id=card_node.id) }}">
                    <button type="submit" class="mobile-task-button">å®Œäº†ã«ã™ã‚‹</button>
                </form>
                <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-button mobile-task-button--link">ç·¨é›†</a>
                <form action="{{ url_for('tasks.delete_task', task_id=task.id) }}" method="post" onsubmit="return confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_task_card_detail', node_id=card_node.id) }}">
                    <button type="submit" class="mobile-task-button danger">å‰Šé™¤</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mobile-empty">æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    {% endif %}
</section>

<section class="mobile-section">
    <div class="mobile-section-title">å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ ({{ completed_tasks|length }}ä»¶)</div>
    {% if completed_tasks %}
    <div class="mobile-task-list">
        {% for task in completed_tasks %}
        <div class="mobile-task-card completed">
            <div class="mobile-task-head">
                <div>
                    <div class="mobile-task-title">{{ task.title }}</div>
                    <div class="mobile-task-meta">
                        å®Œäº†æ—¥ {{ task.completed_at.strftime('%Y/%m/%d') if task.completed_at else 'â€”' }}
                    </div>
                </div>
                <span class="mobile-task-status">å®Œäº†</span>
            </div>
            <div class="mobile-task-buttons">
                <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_task_card_detail', node_id=card_node.id) }}">
                    <button type="submit" class="mobile-task-button">æœªå®Œäº†ã«æˆ»ã™</button>
                </form>
                <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-button mobile-task-button--link">ç·¨é›†</a>
                <form action="{{ url_for('tasks.delete_task', task_id=task.id) }}" method="post" onsubmit="return confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_task_card_detail', node_id=card_node.id) }}">
                    <button type="submit" class="mobile-task-button danger">å‰Šé™¤</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mobile-empty">å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    {% endif %}
</section>
{% endblock %}
