{% extends 'mobile/base.html' %}
{% block head_title %}タスク - ATD Mobile{% endblock %}
{% set active_tab = 'tasks' %}

{% block header_profile %}
<div class="mobile-profile-card">
    <div class="mobile-profile-avatar">T</div>
    <div class="mobile-profile-info">
        <div class="mobile-profile-name">タスク一覧</div>
        <div class="mobile-status-input">今日/明日/その他を確認</div>
    </div>
</div>
{% endblock %}

{% block content %}
{% set sections = [
    {'title': '今日のタスク', 'tasks': today_tasks, 'moves': [('tomorrow', '明日へ'), ('other', 'その他へ')], 'empty': '今日のタスクはありません'},
    {'title': '明日のタスク', 'tasks': tomorrow_tasks, 'moves': [('today', '今日へ'), ('other', 'その他へ')], 'empty': '明日のタスクはありません'},
    {'title': 'その他のタスク', 'tasks': other_tasks, 'moves': [('today', '今日へ'), ('tomorrow', '明日へ')], 'empty': 'その他のタスクはまだありません'}
] %}

{% for section in sections %}
<section class="mobile-section">
    <div class="mobile-section-title">{{ section.title }}</div>
    {% if section.tasks %}
    <div class="mobile-task-list">
        {% for task in section.tasks %}
        <div class="mobile-task-card">
            <div class="mobile-task-head">
                <div>
                    <div class="mobile-task-title">{{ task.title }}</div>
                    <div class="mobile-task-meta">
                        {% if task.end_date %}期限 {{ task.end_date.strftime('%m/%d') }} ・{% endif %}優先度 {{ task.priority }}
                    </div>
                    {% if task.description %}
                    <div class="mobile-task-desc">{{ task.description }}</div>
                    {% endif %}
                </div>
                {% if task.completed %}
                <span class="mobile-task-status">完了</span>
                {% endif %}
            </div>
            <div class="mobile-task-buttons">
                {% for category, label in section.moves %}
                <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                    <input type="hidden" name="category" value="{{ category }}">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                    <button type="submit" class="mobile-task-button">{{ label }}</button>
                </form>
                {% endfor %}
                <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                    <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                    <button type="submit" class="mobile-task-button">完了切替</button>
                </form>
                <button type="button" class="mobile-task-button mobile-track-button" data-task-id="{{ task.id }}" data-action="start" {% if task.is_tracking %}disabled{% endif %}>計測オン</button>
                <button type="button" class="mobile-task-button mobile-track-button" data-task-id="{{ task.id }}" data-action="stop" {% if not task.is_tracking %}disabled{% endif %}>計測オフ</button>
                {% if task.mindmap_node %}
                <button type="button" class="mobile-task-button" onclick="location.href='{{ url_for('main.mobile_task_cards') }}'">カードを見る</button>
                {% else %}
                <button type="button" class="mobile-task-button" onclick="createMobileTaskCard({{ task.id }})">カード作成</button>
                {% endif %}
                <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-button mobile-task-button--link">編集</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mobile-empty">{{ section.empty }}</div>
    {% endif %}
</section>
{% endfor %}

    <div class="mobile-section-actions">
        <a href="{{ url_for('tasks.mobile_create_task') }}" class="mobile-action-chip highlight">新しいタスクを作成</a>
        <a href="{{ url_for('main.mobile_calendar') }}" class="mobile-action-chip">カレンダービュー</a>
</div>

<script>
document.querySelectorAll('.mobile-track-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const taskId = btn.dataset.taskId;
        const action = btn.dataset.action;
        btn.disabled = true;
        fetch(`/tasks/${taskId}/toggle-tracking`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for('main.mobile_tasks') }}';
            } else {
                alert(data.message || 'エラーが発生しました');
                window.location.href = '{{ url_for('main.mobile_tasks') }}';
            }
        })
        .catch(() => {
            alert('通信に失敗しました');
            window.location.href = '{{ url_for('main.mobile_tasks') }}';
        });
    });
});

function createMobileTaskCard(taskId) {
    if (!confirm('このタスクからカードを作成しますか？')) return;
    fetch(`/tasks/${taskId}/task-card`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (confirm('カードを作成しました。詳細ページに移動しますか？')) {
                window.location.href = `/mobile/task-cards/${data.node_id}`;
            } else {
                window.location.href = '{{ url_for('main.mobile_tasks') }}';
            }
        } else {
            alert(data.message || 'カードの作成に失敗しました');
        }
    })
    .catch(() => alert('カードの作成に失敗しました'));
}
</script>
{% endblock %}

