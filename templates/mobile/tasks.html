{% extends 'mobile/base.html' %}
{% block head_title %}タスク - ATD Mobile{% endblock %}
{% set active_tab = 'tasks' %}

{% block header_profile %}
<div class="mobile-profile-card">
    <div class="mobile-profile-avatar">T</div>
    <div class="mobile-profile-info">
        <div class="mobile-profile-name">タスク一覧</div>
        <div class="mobile-status-input">今日/明日/その他を確認</div>
    </div>
</div>
{% endblock %}

{% block content %}
<section class="mobile-section">
    <div class="mobile-section-title">今日のタスク</div>
    {% if today_tasks %}
        <div class="mobile-card">
            <div class="mobile-list">
                {% for task in today_tasks %}
                <div class="mobile-list-item">
                    <div class="mobile-list-icon">{{ loop.index }}</div>
                    <div class="mobile-list-content">
                        <div class="mobile-list-title">{{ task.title }}</div>
                        <div class="mobile-list-meta">
                            {% if task.end_date %}期限 {{ task.end_date.strftime('%m/%d') }}・{% endif %}優先度 {{ task.priority }}
                        </div>
                        <div class="mobile-task-actions">
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="tomorrow">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">明日へ</button>
                            </form>
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="other">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">その他へ</button>
                            </form>
                            <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">完了切替</button>
                            </form>
                        </div>
                        <div class="mobile-task-actions">
                            {% if not task.mindmap_node %}
                            <form action="{{ url_for('tasks.add_to_mindmap', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">マップへ</button>
                            </form>
                            {% else %}
                            <span class="mobile-task-note">マップ登録済み</span>
                            {% endif %}
                            <button type="button" class="mobile-track-btn" data-task-id="{{ task.id }}">{% if task.is_tracking %}計測停止{% else %}計測開始{% endif %}</button>
                            <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-link">編集</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="mobile-empty">今日のタスクはありません</div>
    {% endif %}
</section>

<section class="mobile-section">
    <div class="mobile-section-title">明日のタスク</div>
    {% if tomorrow_tasks %}
        <div class="mobile-card">
            <div class="mobile-list">
                {% for task in tomorrow_tasks %}
                <div class="mobile-list-item">
                    <div class="mobile-list-icon">{{ loop.index }}</div>
                    <div class="mobile-list-content">
                        <div class="mobile-list-title">{{ task.title }}</div>
                        <div class="mobile-list-meta">優先度 {{ task.priority }}</div>
                        <div class="mobile-task-actions">
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="today">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">今日へ</button>
                            </form>
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="other">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">その他へ</button>
                            </form>
                            <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">完了切替</button>
                            </form>
                        </div>
                        <div class="mobile-task-actions">
                            {% if not task.mindmap_node %}
                            <form action="{{ url_for('tasks.add_to_mindmap', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">マップへ</button>
                            </form>
                            {% else %}
                            <span class="mobile-task-note">マップ登録済み</span>
                            {% endif %}
                            <button type="button" class="mobile-track-btn" data-task-id="{{ task.id }}">{% if task.is_tracking %}計測停止{% else %}計測開始{% endif %}</button>
                            <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-link">編集</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="mobile-empty">明日のタスクはありません</div>
    {% endif %}
</section>

<section class="mobile-section">
    <div class="mobile-section-title">その他のタスク</div>
    {% if other_tasks %}
        <div class="mobile-card">
            <div class="mobile-list">
                {% for task in other_tasks %}
                <div class="mobile-list-item">
                    <div class="mobile-list-icon">{{ loop.index }}</div>
                    <div class="mobile-list-content">
                        <div class="mobile-list-title">{{ task.title }}</div>
                        <div class="mobile-list-meta">
                            登録日 {{ task.created_at.strftime('%m/%d') if task.created_at }}
                        </div>
                        <div class="mobile-task-actions">
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="today">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">今日へ</button>
                            </form>
                            <form action="{{ url_for('tasks.move_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="category" value="tomorrow">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">明日へ</button>
                            </form>
                            <form action="{{ url_for('tasks.toggle_task', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">完了切替</button>
                            </form>
                        </div>
                        <div class="mobile-task-actions">
                            {% if not task.mindmap_node %}
                            <form action="{{ url_for('tasks.add_to_mindmap', task_id=task.id) }}" method="post">
                                <input type="hidden" name="next" value="{{ url_for('main.mobile_tasks') }}">
                                <button type="submit">マップへ</button>
                            </form>
                            {% else %}
                            <span class="mobile-task-note">マップ登録済み</span>
                            {% endif %}
                            <button type="button" class="mobile-track-btn" data-task-id="{{ task.id }}">{% if task.is_tracking %}計測停止{% else %}計測開始{% endif %}</button>
                            <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="mobile-task-link">編集</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="mobile-empty">その他のタスクはまだありません</div>
    {% endif %}
</section>

<div class="mobile-section-actions">
    <a href="{{ url_for('tasks.create_task', view='desktop') }}" class="mobile-action-chip highlight">新しいタスクを作成</a>
    <a href="{{ url_for('main.calendar', view='desktop') }}" class="mobile-action-chip">カレンダービュー</a>
</div>
<script>
document.querySelectorAll('.mobile-track-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const taskId = btn.dataset.taskId;
        btn.disabled = true;
        btn.textContent = '処理中...';
        fetch(`/tasks/${taskId}/toggle-tracking`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for('main.mobile_tasks') }}';
            } else {
                alert(data.message || 'エラーが発生しました');
                window.location.href = '{{ url_for('main.mobile_tasks') }}';
            }
        })
        .catch(() => {
            alert('通信に失敗しました');
            window.location.href = '{{ url_for('main.mobile_tasks') }}';
        });
    });
});
</script>
{% endblock %}

