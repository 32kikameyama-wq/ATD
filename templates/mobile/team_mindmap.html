{% extends 'mobile/base.html' %}
{% block head_title %}チームマインドマップ - ATD Mobile{% endblock %}
{% set active_tab = 'team' %}
{% block extra_head %}
<style>
.mobile-mindmap-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.mobile-mindmap-card {
    background: var(--mobile-surface);
    border-radius: var(--mobile-radius);
    box-shadow: 0 2px 12px rgba(15, 23, 42, 0.08);
    padding: 18px;
}
.mobile-node-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.mobile-node {
    background: rgba(0, 139, 139, 0.08);
    border-radius: 16px;
    padding: 14px;
}
.mobile-node summary {
    font-weight: 600;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.mobile-node summary span {
    color: var(--mobile-accent);
    font-size: 13px;
    font-weight: 600;
}
.mobile-node details {
    border-radius: 12px;
}
.mobile-node details > div {
    margin-top: 10px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--mobile-muted);
}
.mobile-subtree {
    margin-top: 12px;
    padding-left: 12px;
    border-left: 2px solid rgba(0, 139, 139, 0.2);
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.mobile-node-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}
.mobile-node-actions a {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    border-radius: 12px;
    background: rgba(0, 139, 139, 0.12);
    font-size: 13px;
    font-weight: 600;
    color: var(--mobile-accent);
    text-decoration: none;
}
.mobile-empty-state {
    text-align: center;
    color: var(--mobile-muted);
    padding: 40px 0;
    font-size: 14px;
}
</style>
{% endblock %}

{% block header_profile %}
<div class="mobile-profile-card">
    <div class="mobile-profile-avatar">M</div>
    <div class="mobile-profile-info">
        <div class="mobile-profile-name">チームマインドマップ</div>
        <div class="mobile-status-input">チームごとのOKRとタスクの進捗を一覧</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="mobile-mindmap-wrapper">
    <div class="mobile-mindmap-card">
        <label for="mobile-mindmap-team" style="display:block; font-weight:600; margin-bottom:8px;">チームを選択</label>
        <select id="mobile-mindmap-team" class="mobile-team-select" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--mobile-border);">
            <option value="">チームを選んでください</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div id="mobile-mindmap-content" class="mobile-mindmap-card" style="display:none;"></div>
</div>

<script>
const teamSelect = document.getElementById('mobile-mindmap-team');
const content = document.getElementById('mobile-mindmap-content');

teamSelect.addEventListener('change', async (e) => {
    const teamId = e.target.value;
    if (!teamId) {
        content.style.display = 'none';
        content.innerHTML = '';
        return;
    }
    content.style.display = 'block';
    content.innerHTML = '<p style="text-align:center; color:#777;">読み込み中...</p>';
    try {
        const res = await fetch(`/mindmap/${teamId}/nodes`);
        const data = await res.json();
        const nodes = data.nodes || [];
        renderMindmap(nodes, teamId);
    } catch (error) {
        console.error(error);
        content.innerHTML = '<p class="mobile-empty-state">マインドマップの取得に失敗しました</p>';
    }
});

function buildTree(nodes) {
    const map = new Map();
    nodes.forEach(node => map.set(node.id, { ...node, children: [] }));
    const roots = [];
    map.forEach(node => {
        if (node.parent_id && map.has(node.parent_id)) {
            map.get(node.parent_id).children.push(node);
        } else if (!node.parent_id) {
            roots.push(node);
        }
    });
    return roots;
}

function renderMindmap(nodes, teamId) {
    if (!nodes.length) {
        content.innerHTML = '<p class="mobile-empty-state">ノードがまだ作成されていません</p>';
        return;
    }
    const roots = buildTree(nodes);
    const container = document.createElement('div');
    container.className = 'mobile-node-list';
    roots.forEach(root => container.appendChild(renderNode(root, teamId)));
    content.innerHTML = '';
    content.appendChild(container);
}

function renderNode(node, teamId) {
    const details = document.createElement('details');
    details.className = 'mobile-node';
    details.open = true;

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>${node.title || '無題'}</span><span>${node.progress ?? 0}%</span>`;
    details.appendChild(summary);

    const info = document.createElement('div');
    if (node.description) {
        const desc = document.createElement('p');
        desc.textContent = node.description;
        info.appendChild(desc);
    }
    if (node.due_date) {
        const due = document.createElement('p');
        due.textContent = `期限: ${node.due_date}`;
        info.appendChild(due);
    }
    if (node.tasks && node.tasks.length) {
        const taskList = document.createElement('ul');
        taskList.style.marginTop = '6px';
        node.tasks.forEach(task => {
            const li = document.createElement('li');
            li.textContent = `${task.title} (${task.completion_rate || 0}%)`;
            taskList.appendChild(li);
        });
        info.appendChild(taskList);
    }
    details.appendChild(info);

    const actions = document.createElement('div');
    actions.className = 'mobile-node-actions';
    const detailLink = document.createElement('a');
    detailLink.href = `/team-task-detail/${teamId}/node/${node.id}?view=desktop`;
    detailLink.textContent = '詳細・編集';
    const addLink = document.createElement('a');
    addLink.href = `/team-task-detail/${teamId}/node/${node.id}?view=desktop#add`; 
    addLink.textContent = '子ノード追加';
    actions.appendChild(detailLink);
    actions.appendChild(addLink);
    details.appendChild(actions);

    if (node.children && node.children.length) {
        const subtree = document.createElement('div');
        subtree.className = 'mobile-subtree';
        node.children.sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
        node.children.forEach(child => subtree.appendChild(renderNode(child, teamId)));
        details.appendChild(subtree);
    }
    return details;
}
</script>
{% endblock %}
