# データ保護とバックアップガイド

## 📋 現在のデータ保護状況

### ✅ 実装済みの保護機能

1. **自動データ永続化**
   - すべてのデータは `instance/atd.db` SQLiteファイルに自動保存されます
   - `db.session.commit()` を使用してすべての変更が即座に保存されます
   - サーバー再起動後もデータは失われません

2. **重要なデータ保存箇所**
   - ✅ ユーザー登録: `auth.py` - 毎回 `commit()` で保存
   - ✅ チーム作成: `routes.py` - 毎回 `commit()` で保存
   - ✅ チームメンバー追加: `routes.py` - 毎回 `commit()` で保存
   - ✅ タスク作成: `tasks.py` - 毎回 `commit()` で保存
   - ✅ チームタスク追加: `routes.py` - 毎回 `commit()` で保存
   - ✅ タスク完了切り替え: `routes.py` - 毎回 `commit()` で保存

## 🛡️ データ損失を防ぐ重要なポイント

### 1. サーバー停止時のデータ保護
- SQLiteファイルは永続的に保存されます
- `instance/` フォルダを誤って削除しないこと

### 2. データベースファイルの場所
```
ATDシステム/
└── instance/
    └── atd.db  ← すべてのデータがここに保存されます
```

### 3. ローカル開発時の注意
```bash
# ⚠️ 注意: このコマンドはデータベースを削除します
rm -rf instance/

# ✅ 正しいデータ保持方法
# データを保持したままサーバーを再起動
python app.py
```

## 💾 バックアップ方法

### 方法1: 手動バックアップ（推奨：定期実行）

```bash
# バックアップを作成
cp instance/atd.db backups/atd_backup_$(date +%Y%m%d_%H%M%S).db

# 特定日時でバックアップ
cp instance/atd.db instance/atd.db.backup_20251102
```

### 方法2: 自動バックアップスクリプト

バックアップスクリプトを作成してください:

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="backups"
DATE=$(date +%Y%m%d_%H%M%S)

# バックアップディレクトリ作成
mkdir -p $BACKUP_DIR

# データベースをバックアップ
cp instance/atd.db $BACKUP_DIR/atd_$DATE.db

# 古いバックアップ（7日以上）を削除
find $BACKUP_DIR -name "atd_*.db" -mtime +7 -delete

echo "バックアップ完了: $BACKUP_DIR/atd_$DATE.db"
```

### 方法3: クロンジョブでの自動バックアップ

```bash
# cronで毎日深夜2時にバックアップ
0 2 * * * cd /Users/user/Desktop/ATDシステム && ./backup.sh
```

## 🔄 データ復元方法

### バックアップから復元

```bash
# 現在のデータベースをバックアップ
cp instance/atd.db instance/atd.db.broken

# バックアップから復元
cp backups/atd_20251102_180000.db instance/atd.db

# サーバーを再起動
python app.py
```

## 🌐 デプロイ環境でのデータ保護

### Render.com でのデータ保護

1. **環境変数の設定**
   ```bash
   RENDER_APP_LABEL=atd-task-manager
   ```

2. **定期的なバックアップの取得**
   - Render.comのディスクは永続的ですが、定期的なバックアップを推奨
   - 週次で手動バックアップを取得することを推奨

3. **データベースエクスポート**
   ```bash
   sqlite3 instance/atd.db .dump > backup.sql
   ```

### 本番環境での推奨事項

1. **PostgreSQLへの移行検討**
   - チーム利用時はPostgreSQLの利用を推奨
   - より信頼性の高いデータ保護

2. **自動バックアップ設定**
   - 日次バックアップの自動化
   - クラウドストレージへの保存

## ⚠️ 重要な警告

### データを失わないために

1. **絶対にやること**
   - ✅ `instance/atd.db` ファイルを定期的にバックアップ
   - ✅ 重大な更新前には必ずバックアップ取得
   - ✅ デプロイ前にはデータベースファイルを確認

2. **絶対にやらないこと**
   - ❌ `rm -rf instance/` を軽率に実行しない
   - ❌ バックアップなしで大規模な変更をしない
   - ❌ 本番環境で直接データベースを編集しない

## 📊 データ整合性チェック

### 定期的な確認コマンド

```bash
# データベースのテーブル確認
sqlite3 instance/atd.db ".tables"

# ユーザー数の確認
sqlite3 instance/atd.db "SELECT COUNT(*) FROM users;"

# チーム数の確認
sqlite3 instance/atd.db "SELECT COUNT(*) FROM teams;"

# タスク数の確認
sqlite3 instance/atd.db "SELECT COUNT(*) FROM team_tasks;"

# データベースの整合性チェック
sqlite3 instance/atd.db "PRAGMA integrity_check;"
```

## 🚨 緊急時の対応

### データが消えた場合

1. **まず落ち着く**
2. **バックアップを確認**
3. **最新のバックアップから復元**
4. **原因を調査**

### データが更新されない場合

1. **データベースロックの確認**
   ```bash
   sqlite3 instance/atd.db "PRAGMA integrity_check;"
   ```

2. **サーバーログの確認**
   ```bash
   # エラーがないか確認
   tail -f /path/to/server.log
   ```

3. **データベース権限の確認**
   ```bash
   ls -la instance/atd.db
   ```

## 📅 推奨バックアップスケジュール

- **開発環境**: 毎日自動バックアップ
- **本番環境**: 毎日自動 + 週次手動
- **重要更新前**: 必ずバックアップ取得

## ✅ チェックリスト

データ保護のために以下を確認してください：

- [ ] バックアップディレクトリを作成した
- [ ] バックアップスクリプトを作成した
- [ ] 定期的なバックアップ設定をした
- [ ] 最新のバックアップを確認できる
- [ ] 復元手順をテストした
- [ ] チームメンバーにバックアップの重要性を伝えた

## 🔗 関連ファイル

- `instance/atd.db` - メインデータベースファイル
- `backups/` - バックアップディレクトリ（自動作成推奨）
- `.gitignore` - データベースファイルはGitignoreに追加済み

## 📞 サポート

データに関する問題が発生した場合：
1. まずバックアップを確認
2. データベースの整合性をチェック
3. サーバーログを確認
4. 最新のコミットを確認

---

**重要**: データは貴重な資産です。定期的なバックアップを習慣化してください。

